<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pagination & Photos</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .task-item { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background: #fafafa; }
        .task-photo { width: 150px; height: 100px; object-fit: cover; border-radius: 5px; margin: 10px 0; }
        .pagination { display: flex; gap: 10px; align-items: center; margin: 20px 0; }
        .page-btn { padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .page-btn.active { background: #007bff; color: white; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .filters { display: flex; gap: 10px; margin: 20px 0; align-items: center; }
        .filter-btn { padding: 8px 16px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .filter-btn.active { background: #28a745; color: white; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        .loading { text-align: center; padding: 40px; }
        .error { color: red; padding: 20px; background: #ffe6e6; border-radius: 5px; }
        .success { color: green; padding: 20px; background: #e6ffe6; border-radius: 5px; }
        .debug-info { background: #f0f8ff; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Pagination & Photos des T√¢ches</h1>
        
        <!-- Filtres -->
        <div class="card">
            <h3>Filtres et Recherche</h3>
            <div class="filters">
                <button class="filter-btn active" onclick="setStatus('all')">Toutes</button>
                <button class="filter-btn" onclick="setStatus('pending')">En cours</button>
                <button class="filter-btn" onclick="setStatus('completed')">Termin√©es</button>
                <input type="text" id="searchInput" placeholder="Rechercher..." onkeyup="handleSearch(event)">
                <select id="limitSelect" onchange="changeLimit()">
                    <option value="5">5 par page</option>
                    <option value="10" selected>10 par page</option>
                    <option value="20">20 par page</option>
                </select>
            </div>
        </div>

        <!-- Informations de pagination -->
        <div class="card">
            <div id="paginationInfo">Chargement...</div>
        </div>

        <!-- Liste des t√¢ches -->
        <div class="card">
            <h3>Liste des T√¢ches</h3>
            <div id="tasksList">
                <div class="loading">Chargement des t√¢ches...</div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="card">
            <div id="paginationControls" class="pagination">
                <!-- Les contr√¥les seront g√©n√©r√©s dynamiquement -->
            </div>
        </div>

        <!-- Debug -->
        <div class="card">
            <h3>üîç Informations de Debug</h3>
            <div id="debugInfo" class="debug-info">
                <!-- Les infos de debug seront affich√©es ici -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let currentParams = {
            page: 1,
            limit: 10,
            search: '',
            status: 'all'
        };
        let currentData = null;

        // Fonction pour mettre √† jour l'URL
        function updateURL() {
            const params = new URLSearchParams();
            if (currentParams.page > 1) params.set('page', currentParams.page);
            if (currentParams.limit !== 10) params.set('limit', currentParams.limit);
            if (currentParams.search) params.set('search', currentParams.search);
            if (currentParams.status !== 'all') params.set('status', currentParams.status);
            
            const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            window.history.pushState({}, '', newURL);
        }

        // Fonction pour charger les t√¢ches
        async function loadTasks() {
            try {
                document.getElementById('tasksList').innerHTML = '<div class="loading">Chargement...</div>';
                
                const params = new URLSearchParams({
                    page: currentParams.page,
                    limit: currentParams.limit,
                    search: currentParams.search,
                    status: currentParams.status
                });

                const response = await fetch(`${API_BASE}/task?${params}`);
                const data = await response.json();
                
                currentData = data;
                displayTasks(data);
                displayPagination(data.pagination);
                displayDebugInfo(data);
                updateURL();
                
            } catch (error) {
                document.getElementById('tasksList').innerHTML = 
                    `<div class="error">Erreur: ${error.message}</div>`;
                console.error('Erreur:', error);
            }
        }

        // Afficher les t√¢ches
        function displayTasks(data) {
            const container = document.getElementById('tasksList');
            
            if (!data.tasks || data.tasks.length === 0) {
                container.innerHTML = '<div>Aucune t√¢che trouv√©e</div>';
                return;
            }

            const tasksHTML = data.tasks.map(task => `
                <div class="task-item">
                    <h4>üìã ${task.lex_name} (ID: ${task.id})</h4>
                    <p><strong>Description:</strong> ${task.lex_description || 'Aucune description'}</p>
                    <p><strong>Statut:</strong> ${task.completed ? '‚úÖ Termin√©e' : '‚è≥ En cours'}</p>
                    <p><strong>Utilisateur:</strong> ${task.userId}</p>
                    
                    ${task.photoUrl ? `
                        <div>
                            <p><strong>Photo URL:</strong> <code>${task.photoUrl}</code></p>
                            <p><strong>URL compl√®te:</strong> <code>${API_BASE}${task.photoUrl}</code></p>
                            <img src="${API_BASE}${task.photoUrl}" 
                                 alt="Photo de ${task.lex_name}" 
                                 class="task-photo"
                                 onload="console.log('‚úÖ Image charg√©e:', '${task.id}')"
                                 onerror="console.log('‚ùå Erreur image:', '${task.id}'); this.style.border='2px solid red';">
                            <br>
                            <a href="${API_BASE}${task.photoUrl}" target="_blank">üîó Ouvrir l'image</a>
                        </div>
                    ` : '<p><em>Pas de photo</em></p>'}
                </div>
            `).join('');

            container.innerHTML = tasksHTML;
        }

        // Afficher la pagination
        function displayPagination(pagination) {
            const info = document.getElementById('paginationInfo');
            const controls = document.getElementById('paginationControls');
            
            info.innerHTML = `
                üìä Page ${pagination.currentPage} sur ${pagination.totalPages} 
                (${pagination.totalItems} √©l√©ments au total, ${pagination.itemsPerPage} par page)
            `;

            let controlsHTML = '';
            
            // Bouton Pr√©c√©dent
            controlsHTML += `
                <button class="page-btn" ${!pagination.hasPrevPage ? 'disabled' : ''} 
                        onclick="goToPage(${pagination.currentPage - 1})">
                    ‚Üê Pr√©c√©dent
                </button>
            `;

            // Num√©ros de pages
            for (let i = 1; i <= pagination.totalPages; i++) {
                if (i === pagination.currentPage) {
                    controlsHTML += `<button class="page-btn active">${i}</button>`;
                } else if (Math.abs(i - pagination.currentPage) <= 2 || i === 1 || i === pagination.totalPages) {
                    controlsHTML += `<button class="page-btn" onclick="goToPage(${i})">${i}</button>`;
                } else if (Math.abs(i - pagination.currentPage) === 3) {
                    controlsHTML += `<span>...</span>`;
                }
            }

            // Bouton Suivant
            controlsHTML += `
                <button class="page-btn" ${!pagination.hasNextPage ? 'disabled' : ''} 
                        onclick="goToPage(${pagination.currentPage + 1})">
                    Suivant ‚Üí
                </button>
            `;

            controls.innerHTML = controlsHTML;
        }

        // Afficher les infos de debug
        function displayDebugInfo(data) {
            const debugContainer = document.getElementById('debugInfo');
            debugContainer.innerHTML = `
                <strong>Param√®tres actuels:</strong><br>
                ${JSON.stringify(currentParams, null, 2)}<br><br>
                
                <strong>URL actuelle:</strong><br>
                ${window.location.href}<br><br>
                
                <strong>R√©ponse API (structure):</strong><br>
                {
                  "tasks": [${data.tasks.length} √©l√©ments],
                  "pagination": ${JSON.stringify(data.pagination, null, 2)}
                }<br><br>
                
                <strong>T√¢ches avec photos:</strong><br>
                ${data.tasks.filter(t => t.photoUrl).map(t => `ID ${t.id}: ${t.photoUrl}`).join('<br>') || 'Aucune'}
            `;
        }

        // Actions
        function goToPage(page) {
            currentParams.page = page;
            loadTasks();
        }

        function setStatus(status) {
            // Mettre √† jour les boutons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentParams.status = status;
            currentParams.page = 1;
            loadTasks();
        }

        function changeLimit() {
            currentParams.limit = parseInt(document.getElementById('limitSelect').value);
            currentParams.page = 1;
            loadTasks();
        }

        function handleSearch(event) {
            if (event.key === 'Enter' || event.type === 'input') {
                currentParams.search = event.target.value;
                currentParams.page = 1;
                loadTasks();
            }
        }

        // Initialisation
        window.onload = function() {
            // R√©cup√©rer les param√®tres de l'URL
            const urlParams = new URLSearchParams(window.location.search);
            currentParams.page = parseInt(urlParams.get('page')) || 1;
            currentParams.limit = parseInt(urlParams.get('limit')) || 10;
            currentParams.search = urlParams.get('search') || '';
            currentParams.status = urlParams.get('status') || 'all';
            
            // Mettre √† jour l'interface
            document.getElementById('searchInput').value = currentParams.search;
            document.getElementById('limitSelect').value = currentParams.limit;
            
            // Charger les t√¢ches
            loadTasks();
        };
    </script>
</body>
</html>